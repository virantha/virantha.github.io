<!DOCTYPE html>
<html lang="en">

<head>
      <link rel="stylesheet" type="text/css" href="https://virantha.github.io/theme/css/style.css">

  <link rel="stylesheet" type="text/css" href="https://virantha.github.io/theme/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=PT+Sans|PT+Serif|Ubuntu+Mono">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" rel="stylesheet">
  <!---
  <link rel="stylesheet" type="text/css" href="https://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/css/jquery.dataTables.css">
  <link rel="stylesheet" href="/theme/tipuesearch/tipuesearch.css">
  -->
  
  <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.dataTables.css" />
    
  <script src="https://code.jquery.com/jquery-3.7.1.min.js""></script>
  <script src="https://cdn.datatables.net/2.1.8/js/dataTables.js"></script>

  <link rel="stylesheet" href="https://files.stork-search.net/releases/v1.6.0/basic.css" />


  <meta charset="utf-8" />
  <meta name="viewport" id="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Virantha Ekanayake">
  <meta name="description" content="Technical writings by Virantha Ekanayake">

  <link rel="author" href="https://plus.google.com/+ViranthaEkanayake/?rel=author">


<meta name="keywords" content="python, curio, async, await">

  <title>
Part 1 - Building a Fast Event-Driven Simulator for Concurrent Systems of Hardware Processes Using Curio and Python 3.6 | Virantha Namal Ekanayake  </title>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-45383503-1', 'virantha.com');
  ga('send', 'pageview');
</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <a href="https://virantha.github.io">
        <img src="http://localhost:8000/images/static/veezer_mini.jpg" alt="logo" id="logo">
      </a>
      <h2><a href="https://virantha.github.io" class="nohover">Virantha Ekanayake</a></h2>
      <p>Technology * Python * FPGAs * Semiconductors * Startups</p>
      <div class="stork-wrapper">
       <input data-stork="sitesearch" class="stork-input"/>
        <div data-stork="sitesearch-output" class="stork-output"></div>
    </div>
      
      <div>
          <ul>


            <li><a data-email="moc.liamg@ahtnariv:otliam" title="You need javascript enabled to view this email" href="#" class="ext-links email" target="_blank">Email<i class="fa fa-envelope"></i></a></li>



            
            <li><a href="https://twitter.com/virantha" target="_blank"><span class="ext-links">Twitter</span><i class="fa fa-twitter "></i></a></li>



            
            <li><a href="https://www.linkedin.com/pub/virantha-ekanayake/1a/a4b/56" target="_blank"><span class="ext-links">Linkedin</span><i class="fa fa-external-link-square "></i></a></li>



            
            <li><a href="https://github.com/virantha" target="_blank"><span class="ext-links">GitHub</span><i class="fa fa-github "></i></a></li>
            <br>
        </div>
<p>
<!-- AddThis Button BEGIN -->
<div class="sharing addthis_toolbox addthis_default_style addthis_16x16_style">
    <a class="addthis_button_twitter"></a>
    <a class="addthis_button_google_plusone_share"></a>
    <a class="addthis_button_facebook"></a>
    <a class="addthis_button_hackernews"></a>
    <a class="addthis_button_compact"></a><a class="addthis_counter addthis_bubble_style"></a>
</div>
</p>
<script type="text/javascript">var addthis_config = {"data_track_addressbar":true};</script>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-533983e96da03f48"></script>
<!-- AddThis Button END -->
        
      </ul>
    </div>
  </aside>

  <main id="main">
    <header>
      <p id="header">
      
      </p>
<div class='nav-class'>

    <ul>
        <li>
            <a id='head' href="https://virantha.github.io">Home</a> &#124; 
            <ul>
                <li><a href='https://virantha.github.io/blog.html'>All posts</a></li>
                <li><a href='https://virantha.github.io/tags.html'>Tags</a></li>
            </ul>
        </li>
                <li><a href=#'>Projects</a>
                <ul>                        <li><a href="https://virantha.github.io/category/pypdfocr.html"> PyPDFOCR </a> </li>
                        <li><a href="https://virantha.github.io/category/airframe.html"> AirFrame </a> </li>
                        <li><a href="https://virantha.github.io/category/scanpdf.html"> ScanPDF </a> </li>
                        <li><a href="https://virantha.github.io/category/oneresume.html"> OneResumé </a> </li>
                        <li><a href="https://virantha.github.io/category/fundsgather.html"> FundsGather </a> </li>
                        <li><a href="https://virantha.github.io/category/photokeeper.html"> PhotoKeeper </a> </li>
                        <li><a href="https://virantha.github.io/category/bricknil.html"> BrickNil </a> </li>
                </ul>
                </li>
                <li><a href="https://virantha.github.io/category/tech.html"> Tech notes </a> </li>
                <li><a href="https://virantha.github.io/category/snippets.html"> Snippets </a> </li>
                <li><a href="https://virantha.github.io/category/diy.html"> DIY </a> </li>
                <li><a href="https://virantha.github.io/category/shopping.html"> Shopping </a> </li>
                    <!--
                    <div class="stork-wrapper-edible">
                        <input data-stork="federalist-edible" class="stork-input" />
                        <div data-stork="federalist-edible-output" class="stork-output"></div>
                    </div>
                    -->
                    
    </ul>
</div>
<p>Posted
 by virantha
on Fri 22 September 2017 </p>
    </header>

<article>
  <div class="article_title">
    <h1><a href="https://virantha.github.io/2017/09/22/hardware-simulation-using-curio/" class="nohover">Part 1 - Building a Fast Event-Driven Simulator for Concurrent Systems of Hardware Processes Using Curio and Python 3.6</a></h1>
  </div>
  <div class="article_text">
    <p>In this post, the first in a series of three, I'm going to show you how to
build an elegant simulator of a concurrent system using the amazing <a class="reference external" href="http://curio.readthedocs.io/en/latest/">Curio</a>
library from David Beazley that's built on Python 3.6's async coroutine
features.  I hope it'll provide a nice intro to how to take advantage of
event-driven programming in Python using the <a class="reference external" href="http://curio.readthedocs.io/en/latest/">Curio</a> library and the new
async/await semantics in Python 3.4+ (although I will take advantage of some
cool new 3.6 features to simplify my code).</p>
<p>In Part 1, we'll quickly build a simulation framework, which
will then be enhanced and optimized into a "proper" framework in <a class="reference external" href="https://virantha.github.io/2017/09/27/hardware-simulation-using-curio-2/">Part 2</a>.  I intend
to finish up in <a class="reference external" href="https://virantha.github.io/2017/09/28/hardware-simulation-using-curio-3/">Part 3</a> with a set of concrete examples on how to use it to simulate
your own message-passing hardware systems that can solve interesting problems.</p>
<div class="contents topic" id="table-of-contents">
<p class="topic-title"><a class="reference internal" href="#top">Table of Contents:</a></p>
<ul class="auto-toc simple">
<li><a class="reference internal" href="#background" id="toc-entry-1">1   Background</a></li>
<li><a class="reference internal" href="#describing-hardware-using-communicating-processes" id="toc-entry-2">2   Describing hardware using communicating processes</a></li>
<li><a class="reference internal" href="#building-the-simulator" id="toc-entry-3">3   Building the Simulator</a><ul class="auto-toc">
<li><a class="reference internal" href="#the-process-class" id="toc-entry-4">3.1   The Process class</a></li>
<li><a class="reference internal" href="#the-channel-class" id="toc-entry-5">3.2   The Channel class</a></li>
</ul>
</li>
<li><a class="reference internal" href="#running-the-system" id="toc-entry-6">4   Running the system</a></li>
</ul>
</div>
<div class="section" id="background">
<h2><a class="toc-backref" href="#toc-entry-1">1   Background</a></h2>
<p>First, some background on what I'll be describing:
In graduate school and in my startup, we built hardware using asynchronous
digital logic, and used a high-level abstraction called Communicating Hardware
Processes (CHP) to model and reason about designs.  CHP, based on Tony Hoare's
<a class="reference external" href="http://www.usingcsp.com">CSP</a>, is a way to represent circuits as a concurrent collection of sequential
processes communicating and synchronizing via messaging channels.  I'm not
going to dive into the nuts and bolts of CHP, but I will show you how to build
a simulator that models these types of event-driven systems using an incredibly
small amount of code.</p>
<p>Second, why not <tt class="docutils literal">asyncio</tt>, the new standard library that provides
event-driven programming hooks?  I did start there (and I highly recommend
watching this <a class="reference external" href="https://www.youtube.com/watch?v=M-UcUs7IMIM">talk</a> by Robert Smallshire that builds up to the async constructs
in Python 3.4 from the ground up), but in the end, I found <tt class="docutils literal">asyncio</tt> a little
too complicated and convoluted to get into quickly.  It provides a strong set
of different event-driven abstractions based on generators, tasks, channels,
callbacks, and coroutines, and concrete implementations of different uses, but
I was really just looking for something that provided a coroutine based
event-loop, something that Curio provides quite naturally.</p>
</div>
<div class="section" id="describing-hardware-using-communicating-processes">
<h2><a class="toc-backref" href="#toc-entry-2">2   Describing hardware using communicating processes</a></h2>
<p>Let's try to nail down some terminology.</p>
<ul class="simple">
<li><strong>Process</strong> - This represents a piece of processing or code that's being executed sequentially.</li>
<li><strong>Channel</strong> - A channel is used to connect two <em>processes</em> together.  A
channel is strictly unidirectional, and one side is connected to the <em>sender</em>
process and the other side to a <em>receiver</em> process.  Channels are used to
transfer data (like ints or strings) from the sender to the receiver.  A
channel, as a by-product of the way it works, also functions to synchronize
the sender and receiver processes -- if the receiver isn't ready to receive
and the channel is full, then the sender will block until the message is
transferred into the channel.</li>
<li><strong>Port</strong> - The sender process has an <strong>output port</strong> that is connected to the channel, and the receiver has an <strong>input port</strong> on its end of the channel.</li>
</ul>
<p>As an example, let's consider the simple one-place buffer that's shown below.
<sup id="sf-hardware-simulation-using-curio-1-back"><a href="#sf-hardware-simulation-using-curio-1" class="simple-footnote" title="from preprint of Asynchronous VLSI Systems by Rajit Manohar">1</a></sup>  The
single buffer has two ports, with L being the input port, and R being the
output port.  All the buffer does is receive a value on L, store it in <em>x</em>, and then send
it out on R.  We can then construct a <strong>system</strong> of these buffers that implement a
linear pipeline by connecting the adjacent R and L ports with <em>channels</em>.</p>
<div class="figure align-center" style="width: 836px; height: auto; max-width: 100%;">
<img alt="Linear buffers" src="/images/2017/chp/buf.png" style="width: 836px; height: auto; max-width: 100%;">
</div>
</div>
<div class="section" id="building-the-simulator">
<h2><a class="toc-backref" href="#toc-entry-3">3   Building the Simulator</a></h2>
<div class="section" id="the-process-class">
<h3><a class="toc-backref" href="#toc-entry-4">3.1   The Process class</a></h3>
<p>First thing, let's start with a simple class to represent a <em>Process</em> (reminder
that all code I'm writing probably <strong>requires Python 3.6</strong>)</p>
<pre class="code python literal-block"><span class="k">class</span> <span class="nc">Process</span><span class="p">:</span><span class="w">

</span>    <span class="n">next_id</span> <span class="o">=</span> <span class="mi">0</span><span class="w">

</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span><span class="w">
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="w">
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">Process</span><span class="o">.</span><span class="n">next_id</span><span class="w">
</span>        <span class="n">Process</span><span class="o">.</span><span class="n">next_id</span> <span class="o">+=</span> <span class="mi">1</span><span class="w">

</span>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><span class="w">
</span>        <span class="k">return</span> <span class="s2">"</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="w">

</span>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><span class="w">
</span>        <span class="k">return</span> <span class="s2">"</span><span class="si">{}</span><span class="s2">('</span><span class="si">{}</span><span class="s2">')"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="w">

</span>    <span class="k">def</span> <span class="nf">message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span><span class="w">
</span>        <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">m</span><span class="p">))</span>
</pre>
<p>Nothing too crazy here; just a constructor that keeps track of a unique process id for
every single Process that's created, plus some utility functions to create nice
string representations and also a <em>message</em> method to hand output from the process in
a standard way.</p>
<p>I want to segue here and introduce a new feature in 3.6 called <a class="reference external" href="https://www.python.org/dev/peps/pep-0498/">fstrings</a>, which
are faster, cleaner to read, and just plain awesome once you start using them.</p>
<pre class="code python literal-block"><span class="k">class</span> <span class="nc">Process</span><span class="p">:</span><span class="w">

</span>    <span class="n">next_id</span> <span class="o">=</span> <span class="mi">0</span><span class="w">

</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span><span class="w">
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="w">
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">Process</span><span class="o">.</span><span class="n">next_id</span><span class="w">
</span>        <span class="n">Process</span><span class="o">.</span><span class="n">next_id</span> <span class="o">+=</span> <span class="mi">1</span><span class="w">

</span>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><span class="w">
</span>        <span class="k">return</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">"</span><span class="w">

</span>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><span class="w">
</span>        <span class="k">return</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">('</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">')"</span><span class="w">

</span>    <span class="k">def</span> <span class="nf">message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span><span class="w">
</span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre>
<p>Look at that, interpolation of code inside strings!</p>
<p>Alright, now let's create a Process subclass that actually does something
useful: a <em>Source</em> process that sends a specified value on a channel a fixed
number of times.</p>
<pre class="code python literal-block"><span class="k">class</span> <span class="nc">Source</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span><span class="w">

</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">srcval</span><span class="p">):</span><span class="w">
</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w">
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">srcval</span><span class="w">
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span><span class="w">

</span>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chan</span><span class="p">):</span><span class="w">
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">out_chan</span> <span class="o">=</span> <span class="n">chan</span><span class="w">

</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">exec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><span class="w">
</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">):</span><span class="w">
</span>            <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="sa">f</span><span class="s2">"sending </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">val</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span><span class="w">
</span>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_chan</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val</span><span class="p">)</span><span class="w">
</span>            <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="sa">f</span><span class="s2">"sent </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">val</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span><span class="w">
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">"terminated"</span><span class="p">)</span>
</pre>
<p>The constructor lets us set the value and sequence length to output, and the
<em>connect</em> rather naively just connects the passed in channel to an instance variable.
We'll define channels in the next section, but for now, let's focus on the
<strong>exec</strong> method which does the actual work.  The <tt class="docutils literal">async</tt> keyword marks this as
an asynchronously executing coroutine (technically, it marks the method as an  <em>awaitable</em>).  This is the code that will get executed in <a class="reference external" href="http://curio.readthedocs.io/en/latest/">Curio</a>'s event loop.</p>
<p>The code itself iterates the length of the sequence and calls a send method on the output
channel.  The method call is preceded by an <tt class="docutils literal">await</tt> keyword, which is how you call
<tt class="docutils literal">async</tt> methods (the <tt class="docutils literal">send</tt> method will be an async method).  You can read up
on the semantics of this (things like <tt class="docutils literal">yield from</tt>), but if you just remember to use
<tt class="docutils literal">await</tt> before calling an async method as a rule, you'll be all set.</p>
<p>Now, let's further introduce a <em>Sink</em> process that 'eats' values (say from a source), and
the <em>Buffer</em> process described in the previous section that just receives and passes
on a value.</p>
<pre class="code python literal-block"><span class="kn">from</span> <span class="nn">curio</span> <span class="kn">import</span> <span class="n">CancelledError</span><span class="w">
</span><span class="k">class</span> <span class="nc">Sink</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span><span class="w">

</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span><span class="w">
</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w">

</span>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chan</span><span class="p">):</span><span class="w">
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">in_chan</span> <span class="o">=</span> <span class="n">chan</span><span class="w">

</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">exec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><span class="w">
</span>        <span class="n">tok_count</span> <span class="o">=</span> <span class="mi">0</span><span class="w">
</span>        <span class="k">try</span><span class="p">:</span><span class="w">
</span>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span><span class="w">
</span>                <span class="n">tok</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_chan</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span><span class="w">
</span>                <span class="n">tok_count</span> <span class="o">+=</span> <span class="mi">1</span><span class="w">
</span>                <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="sa">f</span><span class="s2">"received </span><span class="si">{</span><span class="n">tok</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span><span class="w">
</span>        <span class="k">except</span> <span class="n">CancelledError</span><span class="p">:</span><span class="w">
</span>            <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">tok_count</span><span class="si">}</span><span class="s2"> tokens received"</span><span class="p">)</span><span class="w">

</span><span class="k">class</span> <span class="nc">Buffer</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span><span class="w">

</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span><span class="w">
</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w">

</span>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chan_l</span><span class="p">,</span> <span class="n">chan_r</span><span class="p">):</span><span class="w">
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">l_chan</span> <span class="o">=</span> <span class="n">chan_l</span><span class="w">
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">r_chan</span> <span class="o">=</span> <span class="n">chan_r</span><span class="w">

</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">exec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><span class="w">
</span>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span><span class="w">
</span>            <span class="n">tok</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_chan</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span><span class="w">
</span>            <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="sa">f</span><span class="s2">"received </span><span class="si">{</span><span class="n">tok</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span><span class="w">
</span>            <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="sa">f</span><span class="s2">"sending </span><span class="si">{</span><span class="n">tok</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span><span class="w">
</span>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_chan</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">tok</span><span class="p">)</span>
</pre>
<p>One new thing here is how we receive data from an <tt class="docutils literal">async</tt> method.  The
incoming data (or token) is assigned to the result of the <tt class="docutils literal">await
self.in_chan.recv()</tt> call.  (Recall that the shortcut is, wherever we'd do a
function call in synchronous code, we do an <tt class="docutils literal">await</tt> on the function call
instead in async code).  The other point to note is that we can catch a
<em>CancelledError</em> like in the <em>Sink</em> process to print something out if this
process is terminated by the environment (which it will be, since otherwise
it will just hang waiting for more input).</p>
</div>
<div class="section" id="the-channel-class">
<h3><a class="toc-backref" href="#toc-entry-5">3.2   The Channel class</a></h3>
<p>One more thing before we can make our first attempt at simulating a system of
processes: We need a way to implement the communication channels.  Luckily, Curio has
a built-in Queue type that's explicitly designed for this kind of communication.</p>
<p>Here's our first stab at the Channel class, assuming we've done a <tt class="docutils literal">from curio import Queue</tt>:</p>
<pre class="code python literal-block"><span class="kn">from</span> <span class="nn">curio</span> <span class="kn">import</span> <span class="n">Queue</span><span class="w">
</span><span class="k">class</span> <span class="nc">Channel</span><span class="p">:</span><span class="w">

</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span><span class="w">
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="w">
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Max buffering of 1</span><span class="w">

</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span><span class="w">
</span>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="w">

</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">recv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><span class="w">
</span>        <span class="n">tok</span> <span class="o">=</span>  <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="w">
</span>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span><span class="w">
</span>        <span class="k">return</span> <span class="n">tok</span><span class="w">

</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><span class="w">
</span>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre>
<p>Here, we've defined a Channel that has the actions <em>send</em> and <em>recv</em> (and a
utility function <em>close</em> to terminate it).  The <em>send</em> inserts a value into the
internal Queue, and the <em>recv</em> will <tt class="docutils literal">await</tt> on the value (and block if none
is available).  Once the <em>recv</em> is done, it's important to call the
<tt class="docutils literal">task_done</tt> method on the Queue to signal that the receive is complete.</p>
</div>
</div>
<div class="section" id="running-the-system">
<h2><a class="toc-backref" href="#toc-entry-6">4   Running the system</a></h2>
<p>Now we have all the initial pieces available to put together a complete simulation
of a linear pipeline of buffers with its environment.  Here's our first version of the code:</p>
<pre class="code python literal-block"><span class="kn">from</span> <span class="nn">curio</span> <span class="kn">import</span> <span class="n">run</span><span class="p">,</span> <span class="n">spawn</span><span class="w">
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">system</span><span class="p">():</span><span class="w">

</span>    <span class="n">N</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># How many buffers in our linear pipeline</span><span class="w">

</span>    <span class="c1"># Define the channels</span><span class="w">
</span>    <span class="n">chan_l</span> <span class="o">=</span> <span class="n">Channel</span><span class="p">(</span><span class="s1">'l'</span><span class="p">)</span><span class="w">
</span>    <span class="n">chan_r</span> <span class="o">=</span> <span class="p">[]</span><span class="w">
</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span><span class="w">
</span>        <span class="n">chan_r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Channel</span><span class="p">(</span><span class="sa">f</span><span class="s1">'R[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">]'</span><span class="p">))</span><span class="w">

</span>    <span class="c1"># Instantiate the processes</span><span class="w">
</span>    <span class="n">src</span> <span class="o">=</span> <span class="n">Source</span><span class="p">(</span><span class="s1">'src1'</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="w">
</span>    <span class="n">buf</span> <span class="o">=</span> <span class="p">[</span><span class="n">Buffer</span><span class="p">(</span><span class="sa">f</span><span class="s1">'buf[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">]'</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span><span class="w">
</span>    <span class="n">snk</span> <span class="o">=</span> <span class="n">Sink</span><span class="p">(</span><span class="s1">'snk'</span><span class="p">)</span><span class="w">

</span>    <span class="c1"># Connect the processes with the channels</span><span class="w">
</span>    <span class="n">src</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">chan_l</span><span class="p">)</span><span class="w">
</span>    <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">chan_l</span><span class="p">,</span> <span class="n">chan_r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w">
</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span><span class="w">
</span>        <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">chan_r</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">chan_r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
</span>    <span class="n">snk</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">chan_r</span><span class="p">[</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="w">

</span>    <span class="c1"># Start the processes</span><span class="w">
</span>    <span class="n">p_src</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spawn</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">exec</span><span class="p">())</span><span class="w">
</span>    <span class="n">p_snk</span> <span class="o">=</span> <span class="k">await</span> <span class="n">spawn</span><span class="p">(</span><span class="n">snk</span><span class="o">.</span><span class="n">exec</span><span class="p">())</span><span class="w">
</span>    <span class="n">p_buf</span> <span class="o">=</span> <span class="p">[</span><span class="k">await</span> <span class="n">spawn</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">exec</span><span class="p">())</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span><span class="w">

</span>    <span class="c1"># Wait for the source to finish sending all its values</span><span class="w">
</span>    <span class="k">await</span> <span class="n">p_src</span><span class="o">.</span><span class="n">join</span><span class="p">()</span><span class="w">
</span>    <span class="c1"># Cancel the remaining processes</span><span class="w">
</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span><span class="w">
</span>        <span class="k">await</span> <span class="n">p_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span><span class="w">
</span>    <span class="k">await</span> <span class="n">p_snk</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span><span class="w">

</span><span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s1">'__main__'</span><span class="p">:</span><span class="w">
</span>    <span class="n">run</span><span class="p">(</span><span class="n">system</span><span class="p">(),</span> <span class="n">with_monitor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre>
<p>It's still a little more verbose than I'd like, but we'll fix that in the next part.
Notice how all the Processes are started: We do an <tt class="docutils literal">await spawn</tt> on the coroutines
(in this case the <tt class="docutils literal">exec</tt> coroutine method of our Processes) to start all the
Processes running as tasks in Curio's event loop.  Then, we just wait for the
<em>Source</em> process to be complete by doing a <tt class="docutils literal">join()</tt> on its task.  Once we know the
<em>Source</em> is done, we can go ahead and call <tt class="docutils literal">cancel()</tt> on all the remaining tasks,
because we know they are just waiting on their input channels.</p>
<pre class="code text literal-block">src1.0: sending 1
src1.0: sent 1
src1.0: sending 1
buf[0].1: received 1
buf[0].1: sending 1
buf[1].2: received 1
buf[1].2: sending 1
buf[2].3: received 1
buf[2].3: sending 1
.
.
.
src1.0: sent 1
src1.0: terminated
buf[1].2: received 1
buf[1].2: sending 1
.
.
.
buf[8].9: received 1
buf[8].9: sending 1
snk.11: received 1
buf[9].10: received 1
buf[9].10: sending 1
snk.11: received 1
snk.11: 10 tokens received
</pre>
<p>And there you go, a complete distributed system, simulated using Curio's
concurrent event loop!  You can find the complete runnable code (Python 3.6!)
in this <a class="reference external" href="https://gist.github.com/ce2bca039ce3522e1b4efccf0fe49c01">gist</a>.</p>
<p><a class="reference external" href="https://virantha.github.io/2017/09/27/hardware-simulation-using-curio-2/">In the next article</a> in this series, we'll talk about enhancing the simulator
and adding some error-checking.</p>
</div>
<ol class="simple-footnotes"><li id="sf-hardware-simulation-using-curio-1">from preprint of Asynchronous VLSI Systems by Rajit Manohar <a href="#sf-hardware-simulation-using-curio-1-back" class="simple-footnote-back">↩︎</a></li></ol>
  </div>
  <div class="article_meta">
    <p>Category: <a href="https://virantha.github.io/category/tech.html">Tech</a></p>
    <p>Tags:
      <a href="https://virantha.github.io/tag/python.html">python</a>,      <a href="https://virantha.github.io/tag/curio.html">curio</a>,      <a href="https://virantha.github.io/tag/async.html">async</a>,      <a href="https://virantha.github.io/tag/await.html">await</a>    </p>
    <!-- AddThis Button BEGIN -->
    <div class="addthis_toolbox addthis_default_style">
        <a class="addthis_button_tweet"></a>
        <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
        <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
        <a class="addthis_counter addthis_pill_style"></a>
    </div>
    <script type="text/javascript">var addthis_config = {"data_track_addressbar":true};</script>
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-533983e96da03f48"></script>
    <script type="text/javascript">
        var addthis_config = addthis_config||{};
        addthis_config.data_track_addressbar = false;
        addthis_config.data_track_clickback = false;
    </script>
    <!-- AddThis Button END -->
  </div>


    <div id="article_comments" style="display:block">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
           var disqus_identifier = "2017/09/22/hardware-simulation-using-curio/";
           (function() {
           var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
           dsq.src = 'https://virantha.disqus.com/embed.js';
           (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
</article>


    <div id="ending_message">
        <p>&copy; Virantha Ekanayake. Built using <a href="https://getpelican.com" target="_blank">Pelican</a>. Modified <a href='https://github.com/virantha/pelican-svbhack'>svbhack</a> theme, based on <a href="https://github.com/pR0Ps/pelican-svbhack" target="_blank">theme</a> by Carey Metcalfe</p>
    </div>
  </main>


  <script type="text/javascript">
    window.onload = function(){
      var e = document.querySelectorAll(".email");
      for (var i = 0; i < e.length; i++) {
        e[i].href = e[i].getAttribute("data-email").split("").reverse().join("");
        e[i].removeAttribute("data-email");
        e[i].removeAttribute("title");
        e[i].removeAttribute("class");
        e[i].setAttribute("class","ext-links");
      }

      $.get("https://ipinfo.io", function (response) {
        //$("#country").html(response.country);
        //response.country = "CA";
        var country_codes = { 
            "GB": { "id" : "virantha-uk-21", "url" : "www.amazon.co.uk"},
            "CA": { "id" : "virantha-ca-20", "url" : "www.amazon.ca"},
            "DE": { "id" : "virantha-de-21", "url" : "www.amazon.de"},
            "FR": { "id" : "viranthacom0c-21", "url" : "www.amazon.fr"},
            "ES": { "id" : "viranthaco0b5-21", "url" : "www.amazon.es"},
            "IT": { "id" : "viranthacom02-21", "url" : "www.amazon.it"}
        } 
        if (response.country in country_codes) {
                
            var e = document.querySelectorAll(".amazon");
            for (var i = 0; i < e.length; i++) {
                e[i].href = e[i].href.replace("www.amazon.com", country_codes[response.country]["url"]);
                e[i].href = e[i].href.replace("virantha-20", country_codes[response.country]["id"]);
                e[i].setAttribute("class","amazn");
             }
        }
        }, "jsonp"); 
    };
  </script>


<script src="https://files.stork-search.net/releases/v1.5.0/stork.js"></script>
<script>
    stork.register("sitesearch", "https://virantha.github.io/search-index.st");
</script>
</body>
</html>